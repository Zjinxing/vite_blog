<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>公众号开发采坑总结 | hello vitepress</title>
    <meta name="description" content="这里是描述">
    <link rel="stylesheet" href="/assets/style.e0355358.css">
    <link rel="modulepreload" href="/assets/Home.7836024b.js">
    <link rel="modulepreload" href="/assets/app.903ca772.js">
    <link rel="modulepreload" href="/assets/公众号开发采坑总结.md.92e032fd.lean.js">
    <link rel="modulepreload" href="/assets/app.903ca772.js">
    <meta name="twitter:title" content="公众号开发采坑总结 | hello vitepress">
    <meta property="og:title" content="公众号开发采坑总结 | hello vitepress">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-5df6160f><div class="sidebar-button" data-v-5df6160f><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="hello vitepress, back to home" data-v-5df6160f data-v-8dbfef3c><!----> hello vitepress</a><div class="flex-grow" data-v-5df6160f></div><div class="nav" data-v-5df6160f><nav class="nav-links" data-v-5df6160f data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/archives/" data-v-45eb32c6>归档 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/tags/" data-v-45eb32c6>分类 <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/archives/" data-v-45eb32c6>归档 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/tags/" data-v-45eb32c6>分类 <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-58e261f2><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#公众号开发踩坑记录">公众号开发踩坑记录</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#真机调试公众号网页">真机调试公众号网页</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#微信-js-sdk-的配置问题">微信 js-sdk 的配置问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#js-sdk-选择多张图片问题">js-sdk 选择多张图片问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#移动端输入框-maxlength-遇到-emoji-的问题">移动端输入框 maxLength 遇到 emoji 的问题</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-d36a7fda><div class="container" data-v-d36a7fda><!--[--><!--]--><div class="content" data-v-d36a7fda><div data-v-d36a7fda><h2 id="公众号开发踩坑记录"><a class="header-anchor" href="#公众号开发踩坑记录" aria-hidden="true">#</a> 公众号开发踩坑记录</h2><h3 id="真机调试公众号网页"><a class="header-anchor" href="#真机调试公众号网页" aria-hidden="true">#</a> 真机调试公众号网页</h3><blockquote><p>微信公众号网页开发使用微信的 <code>js-sdk</code> 时，需要域名和公众号内配置的 js 接口安全域名一致，而我们开发调试过程中时不可能直接在线上进行的，因此需要一些操作，使我们在手机上访问我们在公众号内绑定的接口安全域名时，映射到我们开发的 PC 上 。</p></blockquote><h4 id="_1-修改本机-hosts-文件"><a class="header-anchor" href="#_1-修改本机-hosts-文件" aria-hidden="true">#</a> 1. 修改本机 hosts 文件</h4><p>打开 hosts 文件，Windows 上在 <code>C:\Windows\System32\drivers\etc</code> 文件夹下，将我们公众号内配置的域名指向 <code>127.0.0.1</code> ，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20201103175122926.png" alt="image-20201103175122926"></p><p>修改完毕之后保存，这时候跑起项目来，我们就可以在微信开发工具中通过访问 <code>test.com</code> + port 来访问我们的项目了。接下来通过 <code>nodejs</code> 写几行代码，使我们可以直接在80端口上访问项目</p><h4 id="_2-端口代理"><a class="header-anchor" href="#_2-端口代理" aria-hidden="true">#</a> 2. 端口代理</h4><p>建立一个 js 文件，在我们启动项目的时候运行一下这个 js 文件，项目跑起来后，我们访问 <code>test.com</code> 就能直接访问到我们开发的项目了</p><div class="language-js"><pre><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> httpProxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http-proxy&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> httpProxy<span class="token punctuation">.</span><span class="token function">createProxyServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 8080 换成自己项目启动的端口</span>
    proxy<span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token operator">:</span> <span class="token string">&#39;http://127.0.0.1:8080&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_3-手机代理设置"><a class="header-anchor" href="#_3-手机代理设置" aria-hidden="true">#</a> 3. 手机代理设置</h4><p>首先在电脑上安装Charles， Charles 是一个抓包工具，我们需要利用它来代理我们的手机网络请求，将我们手机的 <code>test.com</code> 的网络请求转发到本地。安装完毕后选择 <code>代理 &gt; 代理设置</code> 设置代理端口，默认为8888，一般不需要更改。</p><p><img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151054109.png" alt="image-20210112151054109"></p><p>然后手机操作，确保手机和电脑在同一个 WIFI 下，配置代理，服务器填写我们电脑在局域网内的 ip，可以通过 ipconfig 命令查询，端口填写PC上Charles刚刚设置的端口，配置完毕后我们在手机端输入 <code>test.com</code> 就可以愉快的在手机 debug 我们的前端项目了。</p><figure class="half"><img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151552815.png" alt="image-20210112151552815" style="zoom:50%;"><img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151859033.png" alt="image-20210112151859033" style="zoom:50%;"></figure><h3 id="微信-js-sdk-的配置问题"><a class="header-anchor" href="#微信-js-sdk-的配置问题" aria-hidden="true">#</a> 微信 <code>js-sdk</code> 的配置问题</h3><p>公众号开发大部分情况下都要用到微信提供的 <code>js-sdk</code>, 借助 <code>js-sdk</code> 可以使我们方便的调用手机的拍照、语音、位置、等手机系统功能以及一些微信特有的功能，这里我用到了 <code>sdk</code> 的拍照功能。在使用这个 sdk 前，需要先进行配置，执行 <code>wx.config(options)</code> 方法，配置成功后才可以进行调用。配置方法官网描述如下：</p><p><img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112161151569.png" alt="image-20210112161151569"></p><p>其中参数 <code>signature</code> 的生成步骤需要公众号的 <code>AppSecret</code> ，因此这一步要交给后端来完成，前端需要把URL传递给后端，后端获取到签名后返回给前端。在这里有几个坑需要说明一下：</p><ul><li>坑1：官网描述：<code>同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用</code>。 由于在微信中 <code>url</code> 可能在某些条件下微信会加一些参数形如 <code>#STATE</code> ，因此路由尽量使用 <code>history</code> 模式，因此通过URL获取签名的时候URL获取方式为：<code>location.href.split(&#39;#&#39;)[0]</code>。测试之后发现在安卓机和开发者工具上都正常，在 <code>iOS</code> 上提示 <code>invalid signature</code> ，但是刷新一下就提示：<code>config: ok</code> 了，肯定不能让用户去刷新的，一番搜索后发现在 <code>iOS</code> 上不管页面跳转几次都只认首次进入的URL，看到网上有些解决方案是缓存首次进入页面的URL，签名时使用缓存的URL，尝试了一下，都OK了，在iOS上尝试刷新一下结果又不行了，这次连 <code>invalid signature</code> 都没跳出来，<code>wx.config</code> 执行了后完全没反应，但是再刷新一次又可以了。折腾了半天后也没弄好，后来想了一下，既然 <code>iOS</code> 只认首次进入的URL，那么直接在首次进入页面的时候 config 一下不就好了，尝试了一下，做一个判断，如果是 <code>iOS</code> 就只在最顶层组件执行 config，尝试之后完美解决，首页配置后，其他页面调用sdk都没问题，不管刷新多少次都能弹出 <code>config: ok</code> 。</li><li>坑2：拿到URL后需要使用 <code>encodeURI</code> 编码一下，否则某些情况还是会出现 <code>invalid signature</code> 的错误，比如URL中含有拼接的json字符串参数。</li><li>坑3：在PC上的微信内置浏览器中配置成功的，提示：<code>config: ok</code> 但是在调用 sdk 具体功能时提示： <code>permission denied</code> 。这个暂时没找到解决方案，不过我这里只用到了选择图片之类的一些基本功能，在PC上都很好实现，就做了一个判断，如果是PC微信浏览器就不使用微信的 sdk，直接前端实现。</li></ul><h3 id="js-sdk-选择多张图片问题"><a class="header-anchor" href="#js-sdk-选择多张图片问题" aria-hidden="true">#</a> <code>js-sdk</code> 选择多张图片问题</h3><p>微信的 <code>sdk</code> 调用都是回调函数的方式，为了方便使用时对其进行了 promise 化封装，调用了 <code>chooseImage</code> 方法和 <code>getLocalImgData</code> 方法，直接返回图片的 <code>base64</code> 数据，最开始 <code>chooseImage</code> 封装方法如下：</p><div class="language-js"><pre><code><span class="token comment">// 有问题的版本</span>
<span class="token keyword">const</span> <span class="token function-variable function">chooseImage</span> <span class="token operator">=</span> <span class="token parameter">params</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>params<span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> localIds <span class="token punctuation">}</span> <span class="token operator">=</span> res
                <span class="token keyword">const</span> results <span class="token operator">=</span> localIds<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">localId</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">innerResolve<span class="token punctuation">,</span> innerReject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    wx<span class="token punctuation">.</span><span class="token function">getLocalImgData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        localId<span class="token punctuation">,</span>
                        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token function">innerResolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>localData<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token function">innerReject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的方法在选择单张图片的时候没出现问题，但是在选择多张图片的时候发现只返回了一张图片，于是面向搜索引擎编程的我在各种搜索后发现 <code>getLocalImgData</code> 这个方法不能直接遍历，如果遍历执行他就只执行一次后面就不执行了，于是改为递归调用的方式，改进如下：</p><div class="language-js"><pre><code><span class="token comment">// 可以正常选择多张的版本</span>
<span class="token keyword">const</span> <span class="token function-variable function">chooseImg</span> <span class="token operator">=</span> <span class="token parameter">params</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>params<span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> localIds <span class="token punctuation">}</span> <span class="token operator">=</span> res
                <span class="token keyword">const</span> imgList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 用来存储图片base64</span>
                <span class="token keyword">const</span> <span class="token function-variable function">getResults</span> <span class="token operator">=</span> <span class="token parameter">ids</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> localId <span class="token operator">=</span> localIds<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    wx<span class="token punctuation">.</span><span class="token function">getLocalImgData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        localId<span class="token punctuation">,</span>
                        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">const</span> <span class="token punctuation">{</span> localData <span class="token punctuation">}</span> <span class="token operator">=</span> response
                            imgList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>localData<span class="token punctuation">)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ids<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">getResults</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment">// 递归结束</span>
                                <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>imgList<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token function">getResults</span><span class="token punctuation">(</span>localIds<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="移动端输入框-maxlength-遇到-emoji-的问题"><a class="header-anchor" href="#移动端输入框-maxlength-遇到-emoji-的问题" aria-hidden="true">#</a> 移动端输入框 <code>maxLength</code> 遇到 <code>emoji</code> 的问题</h3><p>在移动端使用 <code>input</code> 输入框或者 <code>textarea</code> 文本域的时候，当限制了 <code>maxLength</code> 的时候，在安卓上和 iOS 上表现不同，不同的 <code>emoji</code> 表情的 length 有 2、3、4 等不同的值，但是在 iOS 上 <code>emoji</code> 的长度却被算做了1，比如限制了 <code>maxLength</code> 为5，在安卓上输入两个表情后就无法输入了，而在 iOS 上却可以输入5个 <code>emoji</code>，这个时候在输入框下面添加字数展示的时候，<code>value.length</code> 显示的可能是10或者更大的值，已经超出了我们限制的 <code>maxLength</code>, 因此这里要做一下统一处理，使用 js 来限制字数而不能用 <code>maxLength</code> 来限制，这里搜索了一下，网上大部分用到的方法都是监听输入，处理emoji，然后使用 <code>value.slice(0, maxLength)</code> 来处理的，这里有一个弊端，就是当用户输入已经达到最大限制的时候，把光标移到输入的文本中间，继续输入，会在光标处插入新输入的内容，尾部原来的内容就被截没了，而限制了 <code>maxLength</code> 的输入框在这种情况下是不能输入任何内容的，也不会修改原来的内容，这显然与预期不符合，因此不能简单的使用 <code>slice</code> 截取。</p><p>这里先说一下含有 <code>emoji</code> 的字符串截取问题：上面说到 <code>emoji</code> 的length并不是1，因此当使用字符串的 <code>slice</code> 方法是就有可能遇到一个 <code>emoji</code> 表情被截一半的情况，这种情况下就会出现 <code>�</code> 这种方块问号的乱码，比如：</p><div class="language-js"><pre><code><span class="token keyword">const</span> emojiStr <span class="token operator">=</span> <span class="token string">&#39;123😀&#39;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emojiStr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 5</span>
emojiStr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// &#39;�&#39;</span>
</code></pre></div><p>使用 <code>string.split(&#39;&#39;)</code> 方法将含有 <code>emoji</code> 的字符串转为数组的时候，<code>emoji</code> 表情都会被截成一个个的<code>�</code>，不过使用 <code>Array.from(string)</code> 方法可以将字符中的 <code>emoji</code> 保留而不被截断，如下：</p><div class="language-js"><pre><code><span class="token keyword">const</span> emojiStr <span class="token operator">=</span> <span class="token string">&#39;123😀&#39;</span>
emojiStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token comment">// [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;�&quot;, &quot;�&quot;]</span>
Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>emojiStr<span class="token punctuation">)</span> <span class="token comment">// [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;😀&quot;]</span>
</code></pre></div><p>因此可以借助该方法处理含有 <code>emoji</code> 的字符串截取，方法如下：</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">sliceEmoji</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">!==</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> start <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> end <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> start <span class="token operator">&gt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token string">&#39;参数非法&#39;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> strArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
  <span class="token keyword">const</span> slicedStr <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
  <span class="token comment">// 取两个字符串前面相同的一部分</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strArr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token operator">===</span> slicedStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> slicedStr
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> slicedStr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> strArr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>有了上面的认识，我们就可以按照以下方式来处理限制 <code>maxLength</code> 的输入框：</p><div class="language-tsx"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">Textarea</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selection<span class="token punctuation">,</span> setSelection<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 用来记录光标位置</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 输入框值</span>
    <span class="token keyword">const</span> textareaRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_LENGTH</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 这是根据需要设置的最大可输入值</span>
    
    <span class="token keyword">const</span> <span class="token function-variable function">onSelect</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> selectionStart<span class="token operator">:</span> start<span class="token punctuation">,</span> selectionEnd<span class="token operator">:</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> e
        <span class="token keyword">const</span> el <span class="token operator">=</span> textareaRef<span class="token punctuation">.</span>current
        <span class="token function">setSelection</span><span class="token punctuation">(</span><span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">const</span> <span class="token function-variable function">onChange</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> selection
        <span class="token keyword">const</span> val <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
        <span class="token keyword">const</span> length <span class="token operator">=</span> value<span class="token punctuation">.</span>length
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token constant">MAX_LENGTH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 输入内容未达到限制长度</span>
            <span class="token function">setValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 输入内容超出限制</span>
            <span class="token keyword">const</span> delta <span class="token operator">=</span> length <span class="token operator">-</span> val<span class="token punctuation">.</span>length <span class="token comment">// 输入内容与现有内容的差值</span>
            <span class="token keyword">const</span> before <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span> <span class="token comment">// 光标之前的内容</span>
            <span class="token keyword">const</span> after <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>end <span class="token operator">+</span> delta<span class="token punctuation">)</span> <span class="token comment">// 光标之后的内容</span>
            <span class="token keyword">const</span> diff <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token comment">// 新输入的内容</span>
            <span class="token keyword">const</span> validVal <span class="token operator">=</span> <span class="token function">sliceEmoji</span><span class="token punctuation">(</span>diff<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_LENGTH</span> <span class="token operator">-</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 可输入的内容</span>
            <span class="token keyword">const</span> finallyVal <span class="token operator">=</span> before <span class="token operator">+</span> validVal <span class="token operator">+</span> after <span class="token comment">// 输入框内最终的内容</span>
		    <span class="token function">setValue</span><span class="token punctuation">(</span>finallyVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>textareaRef<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onSelect</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSelect<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onChange<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div></div></div><footer class="page-footer" data-v-d36a7fda data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-3ae295f1><!----></div></div><div class="updated" data-v-5a019cc9><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"intersectionobserver-infinitscroll.md\":\"f8ac09b0\",\"bubblesort.md\":\"8809d1d1\",\"chat-input.md\":\"f8857650\",\"electron-rxdb.md\":\"7c171825\",\"elementui-el-table-sort.md\":\"f81eaf72\",\"index.md\":\"45be0225\",\"javascript-extends.md\":\"7986c988\",\"miniprogram-swipe.md\":\"b3c8aede\",\"service-worker-push-message.md\":\"458f0497\",\"vue3-reactive.md\":\"2da02015\",\"公众号开发采坑总结.md\":\"92e032fd\",\"archives_index.md\":\"74aee713\",\"tags_index.md\":\"79d94f8f\"}")</script>
    <script type="module" async src="/assets/app.903ca772.js"></script>
  </body>
</html>