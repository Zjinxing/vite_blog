---
title: å…¬ä¼—å·å¼€å‘é‡‡å‘æ€»ç»“
date: 2021-02-06 22:48:50
tags:
  - å…¬ä¼—å·
describe: å¾®ä¿¡å…¬ä¼—å·ç½‘é¡µå¼€å‘ä½¿ç”¨å¾®ä¿¡çš„ js-sdk æ—¶ï¼Œéœ€è¦åŸŸåå’Œå…¬ä¼—å·å†…é…ç½®çš„ js æ¥å£å®‰å…¨åŸŸåä¸€è‡´ï¼Œè€Œæˆ‘ä»¬å¼€å‘è°ƒè¯•è¿‡ç¨‹ä¸­æ—¶ä¸å¯èƒ½ç›´æ¥åœ¨çº¿ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤éœ€è¦ä¸€äº›æ“ä½œï¼Œä½¿æˆ‘ä»¬åœ¨æ‰‹æœºä¸Šè®¿é—®æˆ‘ä»¬åœ¨å…¬ä¼—å·å†…ç»‘å®šçš„æ¥å£å®‰å…¨åŸŸåæ—¶ï¼Œæ˜ å°„åˆ°æˆ‘ä»¬å¼€å‘çš„ PC ä¸Š ã€‚
---


## å…¬ä¼—å·å¼€å‘è¸©å‘è®°å½•

### çœŸæœºè°ƒè¯•å…¬ä¼—å·ç½‘é¡µ

> å¾®ä¿¡å…¬ä¼—å·ç½‘é¡µå¼€å‘ä½¿ç”¨å¾®ä¿¡çš„ `js-sdk` æ—¶ï¼Œéœ€è¦åŸŸåå’Œå…¬ä¼—å·å†…é…ç½®çš„ js æ¥å£å®‰å…¨åŸŸåä¸€è‡´ï¼Œè€Œæˆ‘ä»¬å¼€å‘è°ƒè¯•è¿‡ç¨‹ä¸­æ—¶ä¸å¯èƒ½ç›´æ¥åœ¨çº¿ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤éœ€è¦ä¸€äº›æ“ä½œï¼Œä½¿æˆ‘ä»¬åœ¨æ‰‹æœºä¸Šè®¿é—®æˆ‘ä»¬åœ¨å…¬ä¼—å·å†…ç»‘å®šçš„æ¥å£å®‰å…¨åŸŸåæ—¶ï¼Œæ˜ å°„åˆ°æˆ‘ä»¬å¼€å‘çš„ PC ä¸Š ã€‚

#### 1. ä¿®æ”¹æœ¬æœº hosts æ–‡ä»¶

æ‰“å¼€ hosts æ–‡ä»¶ï¼ŒWindows ä¸Šåœ¨ `C:\Windows\System32\drivers\etc` æ–‡ä»¶å¤¹ä¸‹ï¼Œå°†æˆ‘ä»¬å…¬ä¼—å·å†…é…ç½®çš„åŸŸåæŒ‡å‘ `127.0.0.1` ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20201103175122926](https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20201103175122926.png)

ä¿®æ”¹å®Œæ¯•ä¹‹åä¿å­˜ï¼Œè¿™æ—¶å€™è·‘èµ·é¡¹ç›®æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¾®ä¿¡å¼€å‘å·¥å…·ä¸­é€šè¿‡è®¿é—® `test.com` + port æ¥è®¿é—®æˆ‘ä»¬çš„é¡¹ç›®äº†ã€‚æ¥ä¸‹æ¥é€šè¿‡ `nodejs` å†™å‡ è¡Œä»£ç ï¼Œä½¿æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨80ç«¯å£ä¸Šè®¿é—®é¡¹ç›®

#### 2. ç«¯å£ä»£ç†

å»ºç«‹ä¸€ä¸ª js æ–‡ä»¶ï¼Œåœ¨æˆ‘ä»¬å¯åŠ¨é¡¹ç›®çš„æ—¶å€™è¿è¡Œä¸€ä¸‹è¿™ä¸ª js æ–‡ä»¶ï¼Œé¡¹ç›®è·‘èµ·æ¥åï¼Œæˆ‘ä»¬è®¿é—® `test.com` å°±èƒ½ç›´æ¥è®¿é—®åˆ°æˆ‘ä»¬å¼€å‘çš„é¡¹ç›®äº†

```js
const http = require('http')
const httpProxy = require('http-proxy')
const proxy = httpProxy.createProxyServer()

http.createServer(function(req, res) {
    // 8080 æ¢æˆè‡ªå·±é¡¹ç›®å¯åŠ¨çš„ç«¯å£
    proxy.web(req, res, { target: 'http://127.0.0.1:8080' })
}).listen(80)
```

#### 3. æ‰‹æœºä»£ç†è®¾ç½®

é¦–å…ˆåœ¨ç”µè„‘ä¸Šå®‰è£…Charlesï¼Œ Charles æ˜¯ä¸€ä¸ªæŠ“åŒ…å·¥å…·ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨å®ƒæ¥ä»£ç†æˆ‘ä»¬çš„æ‰‹æœºç½‘ç»œè¯·æ±‚ï¼Œå°†æˆ‘ä»¬æ‰‹æœºçš„ `test.com` çš„ç½‘ç»œè¯·æ±‚è½¬å‘åˆ°æœ¬åœ°ã€‚å®‰è£…å®Œæ¯•åé€‰æ‹© `ä»£ç† > ä»£ç†è®¾ç½®` è®¾ç½®ä»£ç†ç«¯å£ï¼Œé»˜è®¤ä¸º8888ï¼Œä¸€èˆ¬ä¸éœ€è¦æ›´æ”¹ã€‚

![image-20210112151054109](https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151054109.png)

ç„¶åæ‰‹æœºæ“ä½œï¼Œç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ä¸ª WIFI ä¸‹ï¼Œé…ç½®ä»£ç†ï¼ŒæœåŠ¡å™¨å¡«å†™æˆ‘ä»¬ç”µè„‘åœ¨å±€åŸŸç½‘å†…çš„ ipï¼Œå¯ä»¥é€šè¿‡ ipconfig å‘½ä»¤æŸ¥è¯¢ï¼Œç«¯å£å¡«å†™PCä¸ŠCharlesåˆšåˆšè®¾ç½®çš„ç«¯å£ï¼Œé…ç½®å®Œæ¯•åæˆ‘ä»¬åœ¨æ‰‹æœºç«¯è¾“å…¥ `test.com` å°±å¯ä»¥æ„‰å¿«çš„åœ¨æ‰‹æœº debug æˆ‘ä»¬çš„å‰ç«¯é¡¹ç›®äº†ã€‚

<figure class="half">
    <img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151552815.png" alt="image-20210112151552815" style="zoom: 50%;" />
    <img src="https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112151859033.png" alt="image-20210112151859033" style="zoom:50%;" />
</figure>




### å¾®ä¿¡ `js-sdk` çš„é…ç½®é—®é¢˜

å…¬ä¼—å·å¼€å‘å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½è¦ç”¨åˆ°å¾®ä¿¡æä¾›çš„ `js-sdk`, å€ŸåŠ© `js-sdk` å¯ä»¥ä½¿æˆ‘ä»¬æ–¹ä¾¿çš„è°ƒç”¨æ‰‹æœºçš„æ‹ç…§ã€è¯­éŸ³ã€ä½ç½®ã€ç­‰æ‰‹æœºç³»ç»ŸåŠŸèƒ½ä»¥åŠä¸€äº›å¾®ä¿¡ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ç”¨åˆ°äº† `sdk` çš„æ‹ç…§åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨è¿™ä¸ª sdk å‰ï¼Œéœ€è¦å…ˆè¿›è¡Œé…ç½®ï¼Œæ‰§è¡Œ `wx.config(options)` æ–¹æ³•ï¼Œé…ç½®æˆåŠŸåæ‰å¯ä»¥è¿›è¡Œè°ƒç”¨ã€‚é…ç½®æ–¹æ³•å®˜ç½‘æè¿°å¦‚ä¸‹ï¼š

![image-20210112161151569](https://cdn.jsdelivr.net/gh/Zjinxing/image-galary@master/blog/image-20210112161151569.png)

å…¶ä¸­å‚æ•° `signature` çš„ç”Ÿæˆæ­¥éª¤éœ€è¦å…¬ä¼—å·çš„ `AppSecret` ï¼Œå› æ­¤è¿™ä¸€æ­¥è¦äº¤ç»™åç«¯æ¥å®Œæˆï¼Œå‰ç«¯éœ€è¦æŠŠURLä¼ é€’ç»™åç«¯ï¼Œåç«¯è·å–åˆ°ç­¾ååè¿”å›ç»™å‰ç«¯ã€‚åœ¨è¿™é‡Œæœ‰å‡ ä¸ªå‘éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼š

- å‘1ï¼šå®˜ç½‘æè¿°ï¼š`åŒä¸€ä¸ªurlä»…éœ€è°ƒç”¨ä¸€æ¬¡ï¼Œå¯¹äºå˜åŒ–urlçš„SPAçš„web appå¯åœ¨æ¯æ¬¡urlå˜åŒ–æ—¶è¿›è¡Œè°ƒç”¨`ã€‚ ç”±äºåœ¨å¾®ä¿¡ä¸­ `url` å¯èƒ½åœ¨æŸäº›æ¡ä»¶ä¸‹å¾®ä¿¡ä¼šåŠ ä¸€äº›å‚æ•°å½¢å¦‚ `#STATE` ï¼Œå› æ­¤è·¯ç”±å°½é‡ä½¿ç”¨ `history` æ¨¡å¼ï¼Œå› æ­¤é€šè¿‡URLè·å–ç­¾åçš„æ—¶å€™URLè·å–æ–¹å¼ä¸ºï¼š`location.href.split('#')[0]`ã€‚æµ‹è¯•ä¹‹åå‘ç°åœ¨å®‰å“æœºå’Œå¼€å‘è€…å·¥å…·ä¸Šéƒ½æ­£å¸¸ï¼Œåœ¨ `iOS` ä¸Šæç¤º `invalid signature` ï¼Œä½†æ˜¯åˆ·æ–°ä¸€ä¸‹å°±æç¤ºï¼š`config: ok` äº†ï¼Œè‚¯å®šä¸èƒ½è®©ç”¨æˆ·å»åˆ·æ–°çš„ï¼Œä¸€ç•ªæœç´¢åå‘ç°åœ¨ `iOS` ä¸Šä¸ç®¡é¡µé¢è·³è½¬å‡ æ¬¡éƒ½åªè®¤é¦–æ¬¡è¿›å…¥çš„URLï¼Œçœ‹åˆ°ç½‘ä¸Šæœ‰äº›è§£å†³æ–¹æ¡ˆæ˜¯ç¼“å­˜é¦–æ¬¡è¿›å…¥é¡µé¢çš„URLï¼Œç­¾åæ—¶ä½¿ç”¨ç¼“å­˜çš„URLï¼Œå°è¯•äº†ä¸€ä¸‹ï¼Œéƒ½OKäº†ï¼Œåœ¨iOSä¸Šå°è¯•åˆ·æ–°ä¸€ä¸‹ç»“æœåˆä¸è¡Œäº†ï¼Œè¿™æ¬¡è¿ `invalid signature` éƒ½æ²¡è·³å‡ºæ¥ï¼Œ`wx.config` æ‰§è¡Œäº†åå®Œå…¨æ²¡ååº”ï¼Œä½†æ˜¯å†åˆ·æ–°ä¸€æ¬¡åˆå¯ä»¥äº†ã€‚æŠ˜è…¾äº†åŠå¤©åä¹Ÿæ²¡å¼„å¥½ï¼Œåæ¥æƒ³äº†ä¸€ä¸‹ï¼Œæ—¢ç„¶ `iOS` åªè®¤é¦–æ¬¡è¿›å…¥çš„URLï¼Œé‚£ä¹ˆç›´æ¥åœ¨é¦–æ¬¡è¿›å…¥é¡µé¢çš„æ—¶å€™ config ä¸€ä¸‹ä¸å°±å¥½äº†ï¼Œå°è¯•äº†ä¸€ä¸‹ï¼Œåšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ `iOS` å°±åªåœ¨æœ€é¡¶å±‚ç»„ä»¶æ‰§è¡Œ configï¼Œå°è¯•ä¹‹åå®Œç¾è§£å†³ï¼Œé¦–é¡µé…ç½®åï¼Œå…¶ä»–é¡µé¢è°ƒç”¨sdkéƒ½æ²¡é—®é¢˜ï¼Œä¸ç®¡åˆ·æ–°å¤šå°‘æ¬¡éƒ½èƒ½å¼¹å‡º `config: ok` ã€‚
- å‘2ï¼šæ‹¿åˆ°URLåéœ€è¦ä½¿ç”¨ `encodeURI` ç¼–ç ä¸€ä¸‹ï¼Œå¦åˆ™æŸäº›æƒ…å†µè¿˜æ˜¯ä¼šå‡ºç° `invalid signature` çš„é”™è¯¯ï¼Œæ¯”å¦‚URLä¸­å«æœ‰æ‹¼æ¥çš„jsonå­—ç¬¦ä¸²å‚æ•°ã€‚
- å‘3ï¼šåœ¨PCä¸Šçš„å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­é…ç½®æˆåŠŸçš„ï¼Œæç¤ºï¼š`config: ok` ä½†æ˜¯åœ¨è°ƒç”¨ sdk å…·ä½“åŠŸèƒ½æ—¶æç¤ºï¼š `permission denied` ã€‚è¿™ä¸ªæš‚æ—¶æ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä¸è¿‡æˆ‘è¿™é‡Œåªç”¨åˆ°äº†é€‰æ‹©å›¾ç‰‡ä¹‹ç±»çš„ä¸€äº›åŸºæœ¬åŠŸèƒ½ï¼Œåœ¨PCä¸Šéƒ½å¾ˆå¥½å®ç°ï¼Œå°±åšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæ˜¯PCå¾®ä¿¡æµè§ˆå™¨å°±ä¸ä½¿ç”¨å¾®ä¿¡çš„ sdkï¼Œç›´æ¥å‰ç«¯å®ç°ã€‚

### `js-sdk` é€‰æ‹©å¤šå¼ å›¾ç‰‡é—®é¢˜

å¾®ä¿¡çš„ `sdk` è°ƒç”¨éƒ½æ˜¯å›è°ƒå‡½æ•°çš„æ–¹å¼ï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨æ—¶å¯¹å…¶è¿›è¡Œäº† promise åŒ–å°è£…ï¼Œè°ƒç”¨äº† `chooseImage` æ–¹æ³•å’Œ `getLocalImgData` æ–¹æ³•ï¼Œç›´æ¥è¿”å›å›¾ç‰‡çš„ `base64` æ•°æ®ï¼Œæœ€å¼€å§‹ `chooseImage` å°è£…æ–¹æ³•å¦‚ä¸‹ï¼š

```js
// æœ‰é—®é¢˜çš„ç‰ˆæœ¬
const chooseImage = params => {
    return new Promise((resolve, reject) => {
        wx.chooseImage({
            ...params,
            success: res => {
                const { localIds } = res
                const results = localIds.map(localId => new Promise((innerResolve, innerReject) => {
                    wx.getLocalImgData({
                        localId,
                        success: response => innerResolve(response.localData),
                        fail: err => innerReject(err)
                    })
                }))
                return resolve(Promise.all(results))
            }
        })
    })
}
```

ä¸Šé¢çš„æ–¹æ³•åœ¨é€‰æ‹©å•å¼ å›¾ç‰‡çš„æ—¶å€™æ²¡å‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨é€‰æ‹©å¤šå¼ å›¾ç‰‡çš„æ—¶å€™å‘ç°åªè¿”å›äº†ä¸€å¼ å›¾ç‰‡ï¼Œäºæ˜¯é¢å‘æœç´¢å¼•æ“ç¼–ç¨‹çš„æˆ‘åœ¨å„ç§æœç´¢åå‘ç° `getLocalImgData` è¿™ä¸ªæ–¹æ³•ä¸èƒ½ç›´æ¥éå†ï¼Œå¦‚æœéå†æ‰§è¡Œä»–å°±åªæ‰§è¡Œä¸€æ¬¡åé¢å°±ä¸æ‰§è¡Œäº†ï¼Œäºæ˜¯æ”¹ä¸ºé€’å½’è°ƒç”¨çš„æ–¹å¼ï¼Œæ”¹è¿›å¦‚ä¸‹ï¼š

```js
// å¯ä»¥æ­£å¸¸é€‰æ‹©å¤šå¼ çš„ç‰ˆæœ¬
const chooseImg = params => {
    return new Promise((resolve, reject) => {
        wx.chooseImage({
            ...params,
            success: res => {
                const { localIds } = res
                const imgList = [] // ç”¨æ¥å­˜å‚¨å›¾ç‰‡base64
                const getResults = ids => {
                    const localId = localIds.shift()
                    wx.getLocalImgData({
                        localId,
                        success: response => {
                            const { localData } = response
                            imgList.push(localData)
                            if (ids.length > 0) {
                                getResults(ids)
                            } else {
                                // é€’å½’ç»“æŸ
                                return resolve(imgList)
                            }
                        }
                    })
                }
                getResults(localIds)
            },
            fail: error => {
                return reject(error)
            },
        })
    })
}
```

### ç§»åŠ¨ç«¯è¾“å…¥æ¡† `maxLength` é‡åˆ° `emoji` çš„é—®é¢˜

åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨ `input` è¾“å…¥æ¡†æˆ–è€… `textarea` æ–‡æœ¬åŸŸçš„æ—¶å€™ï¼Œå½“é™åˆ¶äº† `maxLength` çš„æ—¶å€™ï¼Œåœ¨å®‰å“ä¸Šå’Œ iOS ä¸Šè¡¨ç°ä¸åŒï¼Œä¸åŒçš„ `emoji` è¡¨æƒ…çš„ length æœ‰ 2ã€3ã€4 ç­‰ä¸åŒçš„å€¼ï¼Œä½†æ˜¯åœ¨ iOS ä¸Š `emoji` çš„é•¿åº¦å´è¢«ç®—åšäº†1ï¼Œæ¯”å¦‚é™åˆ¶äº† `maxLength` ä¸º5ï¼Œåœ¨å®‰å“ä¸Šè¾“å…¥ä¸¤ä¸ªè¡¨æƒ…åå°±æ— æ³•è¾“å…¥äº†ï¼Œè€Œåœ¨ iOS ä¸Šå´å¯ä»¥è¾“å…¥5ä¸ª `emoji`ï¼Œè¿™ä¸ªæ—¶å€™åœ¨è¾“å…¥æ¡†ä¸‹é¢æ·»åŠ å­—æ•°å±•ç¤ºçš„æ—¶å€™ï¼Œ`value.length` æ˜¾ç¤ºçš„å¯èƒ½æ˜¯10æˆ–è€…æ›´å¤§çš„å€¼ï¼Œå·²ç»è¶…å‡ºäº†æˆ‘ä»¬é™åˆ¶çš„ `maxLength`, å› æ­¤è¿™é‡Œè¦åšä¸€ä¸‹ç»Ÿä¸€å¤„ç†ï¼Œä½¿ç”¨ js æ¥é™åˆ¶å­—æ•°è€Œä¸èƒ½ç”¨ `maxLength` æ¥é™åˆ¶ï¼Œè¿™é‡Œæœç´¢äº†ä¸€ä¸‹ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†ç”¨åˆ°çš„æ–¹æ³•éƒ½æ˜¯ç›‘å¬è¾“å…¥ï¼Œå¤„ç†emojiï¼Œç„¶åä½¿ç”¨ `value.slice(0, maxLength)` æ¥å¤„ç†çš„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯å½“ç”¨æˆ·è¾“å…¥å·²ç»è¾¾åˆ°æœ€å¤§é™åˆ¶çš„æ—¶å€™ï¼ŒæŠŠå…‰æ ‡ç§»åˆ°è¾“å…¥çš„æ–‡æœ¬ä¸­é—´ï¼Œç»§ç»­è¾“å…¥ï¼Œä¼šåœ¨å…‰æ ‡å¤„æ’å…¥æ–°è¾“å…¥çš„å†…å®¹ï¼Œå°¾éƒ¨åŸæ¥çš„å†…å®¹å°±è¢«æˆªæ²¡äº†ï¼Œè€Œé™åˆ¶äº† `maxLength` çš„è¾“å…¥æ¡†åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸èƒ½è¾“å…¥ä»»ä½•å†…å®¹çš„ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹åŸæ¥çš„å†…å®¹ï¼Œè¿™æ˜¾ç„¶ä¸é¢„æœŸä¸ç¬¦åˆï¼Œå› æ­¤ä¸èƒ½ç®€å•çš„ä½¿ç”¨ `slice` æˆªå–ã€‚

è¿™é‡Œå…ˆè¯´ä¸€ä¸‹å«æœ‰ `emoji` çš„å­—ç¬¦ä¸²æˆªå–é—®é¢˜ï¼šä¸Šé¢è¯´åˆ° `emoji` çš„lengthå¹¶ä¸æ˜¯1ï¼Œå› æ­¤å½“ä½¿ç”¨å­—ç¬¦ä¸²çš„ `slice` æ–¹æ³•æ˜¯å°±æœ‰å¯èƒ½é‡åˆ°ä¸€ä¸ª `emoji` è¡¨æƒ…è¢«æˆªä¸€åŠçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šå‡ºç° `ï¿½` è¿™ç§æ–¹å—é—®å·çš„ä¹±ç ï¼Œæ¯”å¦‚ï¼š

```js
const emojiStr = '123ğŸ˜€'
console.log(emojiStr.length) // 5
emojiStr.slice(3, 4) // 'ï¿½'
```

ä½¿ç”¨ `string.split('')` æ–¹æ³•å°†å«æœ‰ `emoji` çš„å­—ç¬¦ä¸²è½¬ä¸ºæ•°ç»„çš„æ—¶å€™ï¼Œ`emoji` è¡¨æƒ…éƒ½ä¼šè¢«æˆªæˆä¸€ä¸ªä¸ªçš„`ï¿½`ï¼Œä¸è¿‡ä½¿ç”¨ `Array.from(string)` æ–¹æ³•å¯ä»¥å°†å­—ç¬¦ä¸­çš„ `emoji` ä¿ç•™è€Œä¸è¢«æˆªæ–­ï¼Œå¦‚ä¸‹ï¼š

```js
const emojiStr = '123ğŸ˜€'
emojiStr.split('') // ["1", "2", "3", "ï¿½", "ï¿½"]
Array.from(emojiStr) // ["1", "2", "3", "ğŸ˜€"]
```

å› æ­¤å¯ä»¥å€ŸåŠ©è¯¥æ–¹æ³•å¤„ç†å«æœ‰ `emoji` çš„å­—ç¬¦ä¸²æˆªå–ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š 

```js
const sliceEmoji = (str, start, end) => {
  if (typeof str !== 'string' || start < 0 || end < 0 || start > end) {
    throw 'å‚æ•°éæ³•'
  }
  const strArr = Array.from(s).slice(start, end)
  const slicedStr = s.slice(start, end)
  // å–ä¸¤ä¸ªå­—ç¬¦ä¸²å‰é¢ç›¸åŒçš„ä¸€éƒ¨åˆ†
  let result = ''
  if (strArr.join('') === slicedStr) {
    result = slicedStr
    return result
  }
  for (let i = 0; i < strArr.length; i++) {
    if (strArr[i] !== slicedStr[i]) {
      result = strArr.slice(0, i).join('')
      break
    }
  }
  return result
}
```

æœ‰äº†ä¸Šé¢çš„è®¤è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼æ¥å¤„ç†é™åˆ¶ `maxLength` çš„è¾“å…¥æ¡†ï¼š

```tsx
const Textarea = () => {
    const [selection, setSelection] = useState({ start: 0, end: 0 }) // ç”¨æ¥è®°å½•å…‰æ ‡ä½ç½®
    const [value, setValue] = useState('') // è¾“å…¥æ¡†å€¼
    const textareaRef = useRef(null)
    const MAX_LENGTH = 20, // è¿™æ˜¯æ ¹æ®éœ€è¦è®¾ç½®çš„æœ€å¤§å¯è¾“å…¥å€¼
    
    const onSelect = e => {
        const { selectionStart: start, selectionEnd: end } = e
        const el = textareaRef.current
        setSelection({ start, end })
    }
    
    const onChange = e => {
        const { start, end } = selection
        const val = e.target.value
        const length = value.length
        if (length <= MAX_LENGTH) {
            // è¾“å…¥å†…å®¹æœªè¾¾åˆ°é™åˆ¶é•¿åº¦
            setValue(val)
        } else {
            // è¾“å…¥å†…å®¹è¶…å‡ºé™åˆ¶
            const delta = length - val.length // è¾“å…¥å†…å®¹ä¸ç°æœ‰å†…å®¹çš„å·®å€¼
            const before = val.slice(0, start) // å…‰æ ‡ä¹‹å‰çš„å†…å®¹
            const after = val.slice(end + delta) // å…‰æ ‡ä¹‹åçš„å†…å®¹
            const diff = val.slice(start, delta) // æ–°è¾“å…¥çš„å†…å®¹
            const validVal = sliceEmoji(diff, 0, MAX_LENGTH - value.length) // å¯è¾“å…¥çš„å†…å®¹
            const finallyVal = before + validVal + after // è¾“å…¥æ¡†å†…æœ€ç»ˆçš„å†…å®¹
		    setValue(finallyVal)
        }
    }
    
    return <textarea ref={textareaRef} value={value} onSelect={onSelect} onChange={onChange} />
}
```

