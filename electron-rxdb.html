<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>electron 中引入 RxDB 本地数据库总结 | hello vitepress</title>
    <meta name="description" content="这里是描述">
    <link rel="stylesheet" href="/assets/style.4b4f5b57.css">
    <link rel="modulepreload" href="/assets/Home.bc4fedcc.js">
    <link rel="modulepreload" href="/assets/app.d8cb571a.js">
    <link rel="modulepreload" href="/assets/electron-rxdb.md.c2491a00.lean.js">
    <link rel="modulepreload" href="/assets/app.d8cb571a.js">
    <meta name="twitter:title" content="electron 中引入 RxDB 本地数据库总结 | hello vitepress">
    <meta property="og:title" content="electron 中引入 RxDB 本地数据库总结 | hello vitepress">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-5df6160f><div class="sidebar-button" data-v-5df6160f><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="hello vitepress, back to home" data-v-5df6160f data-v-8dbfef3c><!----> hello vitepress</a><div class="flex-grow" data-v-5df6160f></div><div class="nav" data-v-5df6160f><nav class="nav-links" data-v-5df6160f data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/archives/" data-v-45eb32c6>归档 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/tags/" data-v-45eb32c6>分类 <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/" data-v-45eb32c6>首页 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/archives/" data-v-45eb32c6>归档 <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/tags/" data-v-45eb32c6>分类 <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-d36a7fda><div class="container" data-v-d36a7fda><!--[--><!--]--><div class="content" data-v-d36a7fda><div data-v-d36a7fda><p>RxDB 是一个NoSQL的js数据库，可以为网页应用、electron应用、nodejs应用等添加本地数据库，近期开发在electron中用到了本地缓存，使用了这个数据库，这里总结一下。</p><p>RxDB 文档地址： <a href="https://rxdb.info/" target="_blank" rel="noopener noreferrer">https://rxdb.info/</a></p><p>RxDB 仓库地址： <a href="https://github.com/pubkey/rxdb" target="_blank" rel="noopener noreferrer">https://github.com/pubkey/rxdb</a></p><h3 id="安装和引用"><a class="header-anchor" href="#安装和引用" aria-hidden="true">#</a> 安装和引用</h3><div class="language-sh"><pre><code>npm i rxdb --save
</code></pre></div><p>或者使用 <code>yarn</code></p><div class="language-sh"><pre><code>yarn add rxdb
</code></pre></div><p>如果没有安装过 <code>rxjs</code>, <code>rxjs</code> 也需要安装</p><div class="language-sh"><pre><code>npm i rxjs --save
</code></pre></div><p>或者</p><div class="language-sh"><pre><code>yarn add rxjs
</code></pre></div><p>在项目中使用</p><div class="language-js"><pre><code><span class="token comment">// ES6</span>
<span class="token keyword">import</span> RxDB <span class="token keyword">from</span> <span class="token string">&#39;rxdb&#39;</span>

<span class="token comment">// CommonJS</span>
<span class="token keyword">const</span> RxDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;rxdb&#39;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="数据库的创建"><a class="header-anchor" href="#数据库的创建" aria-hidden="true">#</a> 数据库的创建</h3><div class="language-js"><pre><code><span class="token keyword">const</span> db <span class="token operator">=</span> RxDB<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;databasename&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 数据库名称，必须</span>
    adapter<span class="token operator">:</span> <span class="token string">&#39;adapter&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 适配器，必须</span>
    password<span class="token operator">:</span> <span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 密码，可选</span>
    multiInstance<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 可选，默认true</span>
    queryChangeDetection<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 可选，默认false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>name</code> 是数据库名称，是一个唯一标识的字符串，<code>adapter</code> 根据使用环境选择相应的适配器，在electron中使用时，数据默认是存储在项目的根目录中的，项目打包后如果安装在了C盘可能会遇到没有权限写入数据的问题，如果想要改变数据的存储位置可以使用 <code>绝对路径 + name</code> 作为数据库的名称，数据会存储在相应的目录下，在 <code>electron</code> 中，我们可以使用 <code>getPath</code> 方法获取路径：</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;electron&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> dataPath <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">&#39;userData&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 可以获取程序的数据路径</span>
</code></pre></div><p>打包后的程序安装后会在C盘目录 <code>users/username/AppData/Roaming/</code> 下生成一个应用程序的数据文件夹，通过 <code>app.getPath(&#39;userData&#39;)</code> 获取到的路径既是此路径，在此路径下我们的数据可以正常写入和修改。</p><h3 id="rxschema"><a class="header-anchor" href="#rxschema" aria-hidden="true">#</a> RxSchema</h3><p>Schema 是用来定义你的数据结构的，可以在schema中指定哪一个字段作为主键，哪些字段作为索引，以及每个字段的类型，支持的类型有: <code>string, number, boolean, array, integer, object</code>, array 可以指定里边每一项的结构，object 可以指定每一个 key 的类型。定义如下一个 Schema，主键为 <code>id</code>, <code>name</code> 和 <code>age</code> 是必须项。需要注意的是主键不能以下滑线开头，否则会报错。</p><div class="language-js"><pre><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">&#39;schema title&#39;</span><span class="token punctuation">,</span>
  version<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">&#39;a rxdb schema&#39;</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span>
  properties<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span>
      primary<span class="token operator">:</span> <span class="token string">&#39;string&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;string&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">,</span>
      min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      max<span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
      index<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    skills<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;array&#39;</span><span class="token punctuation">,</span>
      items<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span>
        properties<span class="token operator">:</span> <span class="token punctuation">{</span>
          skillName<span class="token operator">:</span> <span class="token string">&#39;string&#39;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;age&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="rxcollection"><a class="header-anchor" href="#rxcollection" aria-hidden="true">#</a> RxCollection</h3><p>结构相同的数据存储在一起构成 <code>collection</code>, <code>collection</code> 中的每一项称为一个 <code>document</code>，RxDB 创建 <code>collection</code> 的方法如下：</p><div class="language-js"><pre><code><span class="token keyword">await</span> rxdatabase<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;collection1&#39;</span><span class="token punctuation">,</span>
  schema<span class="token operator">:</span> schema <span class="token comment">// schema 为上面的schema</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>要访问 <code>collection</code> 可以通过 <code>rxdatabase.collectionName</code> 来获取相应的 <code>collection</code>, 比如访问上面创建的 <code>collection</code> :</p><div class="language-js"><pre><code><span class="token keyword">const</span> collection1 <span class="token operator">=</span> rxdatabase<span class="token punctuation">.</span>collection1
</code></pre></div><p>向 <code>collection</code> 中插入数据有四种方法，分别是: <code>insert(), bulkInsert(), upsert() atomicUpsert()</code> ，<code>insert</code> 方法向 <code>collection</code> 中插入一条数据，如果已经存在主键相同的数据，则会抛出一个错误，<code>bulkInert</code> 用于批量插入数据，当有很多数据时应使用此方法插入。官网文档介绍说此方法比多次调用 <code>insert</code> 要快上很多。<code>upsert</code> 方法插入数据时会检测有没有主键相同的数据，如果没有就直接插入一条新数据，如果已经存在主键相同的数据，则会覆盖掉原来的数据。<code>autoUpsert</code> 用于在很短的时间内对同一条数据多次覆盖写入。如果对同一主键的数据很短时间内进行了 <code>upsert</code> 操作，则可能会抛出一个 <code>409 Conflict</code> 的错误，这是因为进行 <code>upsert</code> 操作时上一个 <code>upsert</code> 操作还未结束。</p><h3 id="rxdb-数据查询"><a class="header-anchor" href="#rxdb-数据查询" aria-hidden="true">#</a> RxDB 数据查询</h3><p>使用 <code>collection.find()</code> 可以构造处一个 <code>RxDBQuery</code> 。RxDB 使用 <a href="https://github.com/cloudant/mango" target="_blank" rel="noopener noreferrer">mango-query-syntax</a> 查询语法，同时也支持链式查询。有以下查询操作：</p><ul><li>lt: 小于</li><li>lte: 小于等于</li><li>eq: 等于</li><li>ne: 不等于</li><li>gt: 大于</li><li>gte: 大于等于</li><li>in: 数组, 对应字段的值必须是其中之一</li><li>nin: 数组，对应字段的值不能是数组中的任何一个</li><li>and: 组合查询，必须满足其中的每一个条件</li><li>or: 组合查询，满足其中之一的条件即可</li><li>exists: 查询存在某个字段或不存在某个字段的数据</li><li>sort: 排序查询，根据某个字段进行排序，&quot;desc&quot; 为降序，&quot;asc&quot; 为升序</li><li>regex: 根据正则表达式查询结果</li></ul><p>其中有一个坑是正则查询的时候，查询汉字表达式查不出任何结果，可能是一个bug，要查询汉字只能写成字符串形式，如下：</p><div class="language-js"><pre><code><span class="token keyword">const</span> reg1 <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">小明</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> reg2 <span class="token operator">=</span> <span class="token string">&#39;小明&#39;</span>
<span class="token keyword">const</span> reg3 <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">xiaoming</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> query1 <span class="token operator">=</span> collection1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span>reg1<span class="token punctuation">)</span> <span class="token comment">// 查询不到任何结果！</span>
<span class="token keyword">const</span> query1 <span class="token operator">=</span> collection1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span>reg2<span class="token punctuation">)</span> <span class="token comment">// 结果为name包含 &#39;小明&#39; 的数据</span>
<span class="token keyword">const</span> query1 <span class="token operator">=</span> collection1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span>reg3<span class="token punctuation">)</span> <span class="token comment">// 结果为name包含 &#39;xiaoming&#39; 的数据</span>
</code></pre></div><p>查询后执行 <code>exec()</code> 方法返回一个查询结果的 <code>Promise</code> :</p><div class="language-js"><pre><code><span class="token keyword">const</span> query <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token comment">// [RxDocument, RxDocument, RxDocument, ...]</span>
</code></pre></div><p><code>collection.findOne</code> 方法也是一种查询方法，与 <code>find</code> 不同的是 <code>findOne</code> 返回值不是一个数组，是一个 <code>document</code> .</p><h3 id="对查询结果的操作"><a class="header-anchor" href="#对查询结果的操作" aria-hidden="true">#</a> 对查询结果的操作</h3><p>查询之后可对结果进行删除和修改等操作：</p><blockquote><p>删除查询到的结果</p></blockquote><div class="language-js"><pre><code><span class="token keyword">const</span> query <span class="token operator">=</span> collection1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>修改查询结果</p></blockquote><div class="language-js"><pre><code><span class="token keyword">const</span> query <span class="token operator">=</span> collection1<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  $inc<span class="token operator">:</span> <span class="token punctuation">{</span>
    age<span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 所有查询到的结果 age + 1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 或者修改值</span>
<span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  $set<span class="token operator">:</span> <span class="token punctuation">{</span>
    age<span class="token operator">:</span> <span class="token number">18</span> <span class="token comment">// 将所有查询到的结果 age 改为 18</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><em>更多详情参见官网文档 <a href="https://rxdb.info/" target="_blank" rel="noopener noreferrer">https://rxdb.info/</a></em></p></div></div><footer class="page-footer" data-v-d36a7fda data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-3ae295f1><!----></div></div><div class="updated" data-v-5a019cc9><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"intersectionobserver-infinitscroll.md\":\"370867fc\",\"bubblesort.md\":\"377b1713\",\"chat-input.md\":\"a38e0ea1\",\"electron-rxdb.md\":\"c2491a00\",\"elementui-el-table-sort.md\":\"353f8f01\",\"index.md\":\"80674214\",\"javascript-extends.md\":\"dadf04c0\",\"miniprogram-swipe.md\":\"ce5ea7a7\",\"service-worker-push-message.md\":\"60a616d7\",\"vue3-reactive.md\":\"569cfa4e\",\"公众号开发采坑总结.md\":\"e2902141\",\"archives_index.md\":\"0d0423ed\",\"tags_index.md\":\"adaab507\"}")</script>
    <script type="module" async src="/assets/app.d8cb571a.js"></script>
  </body>
</html>